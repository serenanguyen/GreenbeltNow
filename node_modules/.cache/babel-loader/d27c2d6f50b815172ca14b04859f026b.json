{"ast":null,"code":"var util = require('util');\n\nvar Stream = require('stream').Stream;\n\nvar DelayedStream = require('delayed-stream');\n\nvar defer = require('./defer.js');\n\nmodule.exports = CombinedStream;\n\nfunction CombinedStream() {\n  this.writable = false;\n  this.readable = true;\n  this.dataSize = 0;\n  this.maxDataSize = 2 * 1024 * 1024;\n  this.pauseStreams = true;\n  this._released = false;\n  this._streams = [];\n  this._currentStream = null;\n}\n\nutil.inherits(CombinedStream, Stream);\n\nCombinedStream.create = function (options) {\n  var combinedStream = new this();\n  options = options || {};\n\n  for (var option in options) {\n    combinedStream[option] = options[option];\n  }\n\n  return combinedStream;\n};\n\nCombinedStream.isStreamLike = function (stream) {\n  return typeof stream !== 'function' && typeof stream !== 'string' && typeof stream !== 'boolean' && typeof stream !== 'number' && !Buffer.isBuffer(stream);\n};\n\nCombinedStream.prototype.append = function (stream) {\n  var isStreamLike = CombinedStream.isStreamLike(stream);\n\n  if (isStreamLike) {\n    if (!(stream instanceof DelayedStream)) {\n      var newStream = DelayedStream.create(stream, {\n        maxDataSize: Infinity,\n        pauseStream: this.pauseStreams\n      });\n      stream.on('data', this._checkDataSize.bind(this));\n      stream = newStream;\n    }\n\n    this._handleErrors(stream);\n\n    if (this.pauseStreams) {\n      stream.pause();\n    }\n  }\n\n  this._streams.push(stream);\n\n  return this;\n};\n\nCombinedStream.prototype.pipe = function (dest, options) {\n  Stream.prototype.pipe.call(this, dest, options);\n  this.resume();\n  return dest;\n};\n\nCombinedStream.prototype._getNext = function () {\n  this._currentStream = null;\n\n  var stream = this._streams.shift();\n\n  if (typeof stream == 'undefined') {\n    this.end();\n    return;\n  }\n\n  if (typeof stream !== 'function') {\n    this._pipeNext(stream);\n\n    return;\n  }\n\n  var getStream = stream;\n  getStream(function (stream) {\n    var isStreamLike = CombinedStream.isStreamLike(stream);\n\n    if (isStreamLike) {\n      stream.on('data', this._checkDataSize.bind(this));\n\n      this._handleErrors(stream);\n    }\n\n    defer(this._pipeNext.bind(this, stream));\n  }.bind(this));\n};\n\nCombinedStream.prototype._pipeNext = function (stream) {\n  this._currentStream = stream;\n  var isStreamLike = CombinedStream.isStreamLike(stream);\n\n  if (isStreamLike) {\n    stream.on('end', this._getNext.bind(this));\n    stream.pipe(this, {\n      end: false\n    });\n    return;\n  }\n\n  var value = stream;\n  this.write(value);\n\n  this._getNext();\n};\n\nCombinedStream.prototype._handleErrors = function (stream) {\n  var self = this;\n  stream.on('error', function (err) {\n    self._emitError(err);\n  });\n};\n\nCombinedStream.prototype.write = function (data) {\n  this.emit('data', data);\n};\n\nCombinedStream.prototype.pause = function () {\n  if (!this.pauseStreams) {\n    return;\n  }\n\n  if (this.pauseStreams && this._currentStream && typeof this._currentStream.pause == 'function') this._currentStream.pause();\n  this.emit('pause');\n};\n\nCombinedStream.prototype.resume = function () {\n  if (!this._released) {\n    this._released = true;\n    this.writable = true;\n\n    this._getNext();\n  }\n\n  if (this.pauseStreams && this._currentStream && typeof this._currentStream.resume == 'function') this._currentStream.resume();\n  this.emit('resume');\n};\n\nCombinedStream.prototype.end = function () {\n  this._reset();\n\n  this.emit('end');\n};\n\nCombinedStream.prototype.destroy = function () {\n  this._reset();\n\n  this.emit('close');\n};\n\nCombinedStream.prototype._reset = function () {\n  this.writable = false;\n  this._streams = [];\n  this._currentStream = null;\n};\n\nCombinedStream.prototype._checkDataSize = function () {\n  this._updateDataSize();\n\n  if (this.dataSize <= this.maxDataSize) {\n    return;\n  }\n\n  var message = 'DelayedStream#maxDataSize of ' + this.maxDataSize + ' bytes exceeded.';\n\n  this._emitError(new Error(message));\n};\n\nCombinedStream.prototype._updateDataSize = function () {\n  this.dataSize = 0;\n  var self = this;\n\n  this._streams.forEach(function (stream) {\n    if (!stream.dataSize) {\n      return;\n    }\n\n    self.dataSize += stream.dataSize;\n  });\n\n  if (this._currentStream && this._currentStream.dataSize) {\n    this.dataSize += this._currentStream.dataSize;\n  }\n};\n\nCombinedStream.prototype._emitError = function (err) {\n  this._reset();\n\n  this.emit('error', err);\n};","map":null,"metadata":{},"sourceType":"script"}